# Step 1: Build stage
FROM node:20-alpine AS build

# Install OpenSSL for Prisma
RUN apk add --no-cache openssl

WORKDIR /app

# Copy package files and install dependencies
COPY package*.json ./
RUN npm install

# Copy Prisma schema and generate client
COPY prisma ./prisma
RUN npx prisma generate

# Copy source code and build (if using TypeScript)
COPY . .
RUN npm run build

# Step 2: Final image for production
FROM node:20-alpine

# Install OpenSSL for Prisma runtime
RUN apk add --no-cache openssl

WORKDIR /app

# Copy package files and install production dependencies
COPY package*.json ./
RUN npm install --only=production

# Copy only necessary files from build stage
COPY --from=build /app/dist ./dist 
COPY --from=build /app/prisma ./prisma
COPY --from=build /app/node_modules/@prisma/client ./node_modules/@prisma/client
COPY --from=build /app/server.js ./server.js

# Expose port
EXPOSE 5000

# Start the application
CMD ["node", "server.js"]